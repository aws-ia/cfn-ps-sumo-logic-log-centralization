AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "This CloudFormation template sets up AWS and Sumo Logic resources for all of the Sumo Logic security apps. (qs-1ut5k5ess)"

Metadata:
  QuickStartDocumentation:
    EntrypointName: "Parameters for deploying the Quick Start"
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "1.1 Sumo Logic access configuration (required)"
        Parameters:
          - Section1aSumoLogicDeployment
          - Section1bSumoLogicAccessID
          - Section1cSumoLogicAccessKey
          - Section1dSumoLogicOrganizationId
          - Section1eSumoLogicResourceRemoveOnDeleteStack

      - Label:
          default: "2.1 CloudTrail app configuration"
        Parameters:
          - Section2aInstallCloudTrailApp
          - Section2bInstallPCICloudTrailApp
          - Section2cInstallCISFoundationApp
          - Section2dInstallCloudTrailMonitoringAnalyticsApp
          - Section2eInstallCloudTrailSecOpsApp
      - Label:
          default: "2.2 S3 configuration"
        Parameters:
          - Section2fCloudTrailCreateBucket
          - Section2gCloudTrailLogsBucketName
      - Label:
          default: "2.3 CloudTrail source configuration"
        Parameters:
          - Section2hCloudTrailCreateLogSource
          - Section2iCloudTrailBucketPathExpression
          - Section2jCloudTrailLogsSourceCategoryName

      - Label:
          default: "3.1 GuardDuty app configuration"
        Parameters:
          - Section3aInstallGuardDutyApps
      - Label:
          default: "3.2 GuardDuty log-source configuration"
        Parameters:
          - Section3bGuardDutyCreateHttpLogsSource
          - Section3cGuardDutyHttpLogsSourceCategoryName

      - Label:
          default: "4.1 VPC flow logs app configuration"
        Parameters:
          - Section4aInstallVpcApps
      - Label:
          default: "4.2 VPC flow logs S3 configuration"
        Parameters:
          - Section4bVpcCreateBucket
          - Section4cVpcLogsBucketName
      - Label:
          default: "4.3 VPC S3 source configuration"
        Parameters:
          - Section4dVpcCreateS3Source
          - Section4eVpcBucketPathExpression
          - Section4fVpcLogsSourceCategoryName

      - Label:
          default: "5.1 Sumo Logic Threat Intel for AWS Config"
        Parameters:
          - Section5aInstallThreatIntelApp
          - Section5bElasticLoadBalancerSourceCategory

      - Label:
          default: "6.1 Sumo Logic S3 Audit app configuration"
        Parameters:
          - Section6aInstallS3AuditApp
      - Label:
          default: "6.2 S3 Audit S3 configuration"
        Parameters:
          - Section6bS3AuditCreateBucket
          - Section6cS3AuditLogsBucketName
      - Label:
          default: "6.3 Sumo Logic S3 Audit source configuration"
        Parameters:
          - Section6dS3AuditCreateS3Source
          - Section6eS3AuditBucketPathExpression
          - Section6fS3AuditLogsSourceCategoryName

      - Label:
          default: "7.1 AWS Security Hub app configuration"
        Parameters:
          - Section7aInstallSecurityHubAuditApp
          - Section7bEnableSecurityHub
      - Label:
          default: "7.2 AWS Security Hub S3 configuration"
        Parameters:
          - Section7cSecurityHubCreateBucket
          - Section7dSecurityHubLogsBucketName
      - Label:
          default: "7.3 Sumo Logic Security Hub S3 source configuration"
        Parameters:
          - Section7eSecurityHubCreateS3Source
          - Section7fSecurityHubBucketPathExpression
          - Section7gSecurityHubLogsSourceCategoryName

      - Label:
          default: "8.1 Sumo Logic AWS WAF app configuration"
        Parameters:
          - Section8aInstallWafApp
      - Label:
          default: "8.2 AWS Kinesis Firehose S3 configuration"
        Parameters:
          - Section8bWafCreateBucket
          - Section8cWafLogsBucketName
      - Label:
          default: "8.3 Sumo Logic AWS WAF S3 source configuration"
        Parameters:
          - Section8dWafCreateDeliveryStreamSource
          - Section8eWafDeliveryStreamSourceCategoryName

      - Label:
          default: "9.1 Sumo Logic AWS Config app configuration"
        Parameters:
          - Section9aInstallConfigApp
      - Label:
          default: "9.2 AWS Config Configuration"
        Parameters:
          - Section9bConfigCreateBucket
          - Section9cConfigLogsBucketName
      - Label:
          default: "9.3 Sumo Logic AWS Config HTTP logs source configuration"
        Parameters:
          - Section9dConfigCreateS3LogsSource
          - Section9eConfigS3BucketLogsPathExpression
          - Section9fConfigS3LogsSourceCategoryName

      - Label:
          default: "10.1 Auto-enable logging configuration"
        Parameters:
          - Section10aEnableAutoLogging
          - Section10bEnableLoggingForExistingResources
      - Label:
          default: "10.2 S3 Audit logs auto-enable configuration"
        Parameters:
          - Section10cS3LoggingBucketPrefix
          - Section10dS3LoggingFilterExpression
      - Label:
          default: "10.3 VPC flow logs auto-enable configuration"
        Parameters:
          - Section10eVPCLoggingBucketPrefix
          - Section10fVPCLoggingFilterExpression
      - Label:
          default: "10.4 Firewall logs auto-enable configuration"
        Parameters:
          - Section10FireWallLoggingFilterExpression
      - Label:
          default: "11.1 Network Firewall app configuration"
        Parameters:
          - Section11InstallNFWApp
      - Label:
          default: "11.2 Network Firewall configuration"
        Parameters:
          - Section11CreateNewFW
          - Section11VPCID
          - Section11SubnetID
          - Section11CreateFirewallPolicy
          - Section11FirewallPolicyArn
          - Section11StatefulRule
          - Section11StatelessRule
      - Label:
          default: "11.3 Network Firewall S3 configuration"
        Parameters:
          - Section11NFWCreateS3Bucket
          - Section11NFWLogsS3BucketName
          - Section11NFWLogsNFWBucketPrefix
      - Label:
          default: "11.4 Network Firewall source configuration"
        Parameters:
          - Section11NFWCreateS3Source
          - Section11NFWS3BucketLogsPathExpression
          - Section11NFWS3SourceCategoryName

      - Label:
          default: "AWS Quick Start configuration"
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
          - QSVersion

    ParameterLabels:
      Section1aSumoLogicDeployment:
        default: "Sumo Logic deployment location"
      Section1bSumoLogicAccessID:
        default: "Sumo Logic access ID"
      Section1cSumoLogicAccessKey:
        default: "Sumo Logic access key"
      Section1dSumoLogicOrganizationId:
        default: "Sumo Logic organization ID"
      Section1eSumoLogicResourceRemoveOnDeleteStack:
        default: "Remove Sumo Logic resources when stack is deleted"

      # CloudTrail apps parameters
      Section2aInstallCloudTrailApp:
        default: "Install Sumo Logic AWS CloudTrail app"
      Section2bInstallPCICloudTrailApp:
        default: "Install Sumo Logic PCI compliance for AWS CloudTrail app"
      Section2cInstallCISFoundationApp:
        default: "Install Sumo Logic CIS AWS Foundations Benchmark app"
      Section2dInstallCloudTrailMonitoringAnalyticsApp:
        default: "Install Amazon CloudTrail - Sumo Cloud Security Monitoring and Analytics App"
      Section2eInstallCloudTrailSecOpsApp:
        default: "Install Sumo Global Intelligence for AWS CloudTrail SecOps App"
      Section2fCloudTrailCreateBucket:
        default: "Create a CloudTrail S3 bucket"
      Section2gCloudTrailLogsBucketName:
        default: "CloudTrail logs S3 bucket name"
      Section2hCloudTrailCreateLogSource:
        default: "Create Sumo Logic CloudTrail logs source"
      Section2iCloudTrailBucketPathExpression:
        default: "Path expression for CloudTrail logs"
      Section2jCloudTrailLogsSourceCategoryName:
        default: "Sumo Logic CloudTrail logs source category name"

      # GuardDuty apps parameters
      Section3aInstallGuardDutyApps:
        default: "Install Sumo Logic GuardDuty app"
      Section3bGuardDutyCreateHttpLogsSource:
        default: "Create Sumo Logic HTTP logs source"
      Section3cGuardDutyHttpLogsSourceCategoryName:
        default: "Sumo Logic HTTP logs source category name"

      # VPC flow logs apps parameters
      Section4aInstallVpcApps:
        default: "Install Sumo Logic VPC flow logs app"
      Section4bVpcCreateBucket:
        default: "Create VPC flow logs S3 bucket"
      Section4cVpcLogsBucketName:
        default: "VPC flow logs S3 bucket name"
      Section4dVpcCreateS3Source:
        default: "Create Sumo Logic S3 logs source"
      Section4eVpcBucketPathExpression:
        default: "Path expression for logs"
      Section4fVpcLogsSourceCategoryName:
        default: "Sumo Logic S3 logs source category name"

      # Threat Intel for AWS Parameters
      Section5aInstallThreatIntelApp:
        default: "Install Sumo Logic Threat Intel app"
      Section5bElasticLoadBalancerSourceCategory:
        default: "Sumo Logic ELB category name"

      # S3 Audit app Parameters
      Section6aInstallS3AuditApp:
        default: "Install Sumo Logic S3 Audit app"
      Section6bS3AuditCreateBucket:
        default: "Create S3 Audit bucket"
      Section6cS3AuditLogsBucketName:
        default: "S3 Audit logs bucket name"
      Section6dS3AuditCreateS3Source:
        default: "Create Sumo Logic S3 Audit logs source"
      Section6eS3AuditBucketPathExpression:
        default: "Path expression for logs"
      Section6fS3AuditLogsSourceCategoryName:
        default: "Sumo Logic S3 Audit logs source category name"

      # Security Hub app Parameters
      Section7aInstallSecurityHubAuditApp:
        default: "Install Sumo Logic AWS Security Hub app"
      Section7bEnableSecurityHub:
        default: "Enable Security Hub for the Region"
      Section7cSecurityHubCreateBucket:
        default: "Create Security Hub S3 bucket"
      Section7dSecurityHubLogsBucketName:
        default: "Security hub logs S3 bucket name"
      Section7eSecurityHubCreateS3Source:
        default: "Create Sumo Logic S3 logs source"
      Section7fSecurityHubBucketPathExpression:
        default: "Path expression for Security Hub logs"
      Section7gSecurityHubLogsSourceCategoryName:
        default: "Sumo Logic S3 logs source category name"

      # WAF app Parameters
      Section8aInstallWafApp:
        default: "Install Sumo Logic AWS WAF app"
      Section8bWafCreateBucket:
        default: "Create S3 bucket"
      Section8cWafLogsBucketName:
        default: "WAF S3 bucket name for backup Kinesis Firehose"
      Section8dWafCreateDeliveryStreamSource:
        default: "Create a Kinesis Firehose Delivery Stream Source for WAF"
      Section8eWafDeliveryStreamSourceCategoryName:
        default: "Sumo Logic AWS Kinesis Firehose Logs Source Category Name"

      # Config app Parameters
      Section9aInstallConfigApp:
        default: "Install Sumo Logic AWS Config app"
      Section9bConfigCreateBucket:
        default: "Create AWS S3 Bucket"
      Section9cConfigLogsBucketName:
        default: "AWS S3 Bucket Name"
      Section9dConfigCreateS3LogsSource:
        default: "Create Sumo Logic Amazon S3 Logs Source"
      Section9eConfigS3BucketLogsPathExpression:
        default: "Path Expression for the logs"
      Section9fConfigS3LogsSourceCategoryName:
        default: "Sumo Logic Amazon S3 Logs Source Category Name"

      # Auto-enable parameters
      Section10aEnableAutoLogging:
        default: "Choose resource to auto-enable S3 logging"
      Section10bEnableLoggingForExistingResources:
        default: "Auto-enable logging for existing AWS resources"
      Section10cS3LoggingBucketPrefix:
        default: "Bucket prefix to store S3 Audit logs"
      Section10dS3LoggingFilterExpression:
        default: "Regex expression to filter S3 buckets"
      Section10eVPCLoggingBucketPrefix:
        default: "Bucket prefix to store VPC flow logs"
      Section10fVPCLoggingFilterExpression:
        default: "Regex expression to filter VPC resources"
      Section10FireWallLoggingFilterExpression:
        default: "Regex expression to filter firewall resources"

      # Network Firewall app parameters
      Section11InstallNFWApp:
        default: "Install Sumo Logic AWS Network Firewall App"
      Section11CreateNewFW:
        default: "Create a firewall"
      Section11VPCID:
        default: "VPC ID for a new firewall"
      Section11SubnetID:
        default: "Subnet ID for new firewall"
      Section11CreateFirewallPolicy:
        default: "Create a firewall policy"
      Section11FirewallPolicyArn:
        default: "ARN of existing network policy"
      Section11StatefulRule:
        default: "Create a default stateful rule group for network policy"
      Section11StatelessRule:
        default: " Create a default stateless rule group for network policy"

      Section11NFWCreateS3Bucket:
        default: "Create AWS S3 bucket"
      Section11NFWLogsS3BucketName:
        default: "AWS NFW logs S3 bucket name"
      Section11NFWLogsNFWBucketPrefix:
        default: "AWS NFW logs S3 bucket prefix"
      Section11NFWCreateS3Source:
        default: "Create Sumo Logic Amazon S3 logs source"
      Section11NFWS3BucketLogsPathExpression:
        default: "Path expression for the logs"
      Section11NFWS3SourceCategoryName:
        default: "Sumo Logic Amazon S3 logs source category name"

      QSS3BucketName:
        default: "Quick Start S3 bucket name"
      QSS3BucketRegion:
        default: "Quick Start S3 bucket Region"
      QSS3KeyPrefix:
        default: "Quick Start S3 key prefix"
      QSVersion:
        default: "Quick Start Version"

Parameters:
  Section1aSumoLogicDeployment:
    Type: String
    AllowedValues:
      - au
      - ca
      - de
      - eu
      - jp
      - us2
      - us1
      - in
      - fed
    Description: "Enter the geographic location of the deployment: au, ca, de, eu, jp, us2, in, fed, or us1."
  Section1bSumoLogicAccessID:
    Type: String
    Description: "Enter the Sumo Logic console access ID, which you received when you created the access key."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic access ID cannot be empty."
  Section1cSumoLogicAccessKey:
    Type: String
    Description: "Enter your Sumo Logic access key. Retrieve this from your Sumo Logic account."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic access key cannot be empty."
    NoEcho: true
  Section1dSumoLogicOrganizationId:
    Description: "Enter your Sumo Logic organization ID, which you can find in the Sumo Logic console, under Account."
    Type: String
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic organization ID cannot be empty."
  Section1eSumoLogicResourceRemoveOnDeleteStack:
    AllowedValues:
      - "true"
      - "false"
    Default: "true"
    Description: 'Choose "false" if you do not want the collector, sources, and Sumo Logic apps to be removed when the stack is deleted.'
    Type: String

  # CloudTrail apps parameters
  Section2aInstallCloudTrailApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section2bInstallPCICloudTrailApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section2cInstallCISFoundationApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section2dInstallCloudTrailMonitoringAnalyticsApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section2eInstallCloudTrailSecOpsApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section2fCloudTrailCreateBucket:
    Type: String
    Description: "Choose Yes to create a CloudTrail S3 bucket for CloudTrail logs."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section2gCloudTrailLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name that has CloudTrail logs."
    Default: ""
  Section2hCloudTrailCreateLogSource:
    Type: String
    Description: "Choose No to skip creation of a Sumo Logic CloudTrail log source."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section2iCloudTrailBucketPathExpression:
    Type: String
    Description: "Path expression must match the folder structure for CloudTrail logs (e.g., AWSLogs/*/CloudTrail/*)."
    Default: "AWSLogs/*/CloudTrail/*"
  Section2jCloudTrailLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting CloudTrail logs. This is used for Threat Intel for AWS app installation also."
    Default: "aws/quickstart/cloudtrail/logs"

  # GuardDuty apps parameters
  Section3aInstallGuardDutyApps:
    Type: String
    Description: "GuardDuty: Install Amazon GuardDuty app.
      GlobalGuardDutyApp: Install Global Intelligence for Amazon GuardDuty app.
      Both: Install both apps.
      Skip: Skip installation of apps."
    Default: "Both"
    AllowedValues:
      - "GuardDuty"
      - "GlobalGuardDuty"
      - "Both"
      - "Skip"
  Section3bGuardDutyCreateHttpLogsSource:
    Type: String
    Description: "Choose No to skip creation of a Sumo Logic HTTP log source to collect GuardDuty logs."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section3cGuardDutyHttpLogsSourceCategoryName:
    Type: String
    Description: "Required when Guardduty HTTP LogSource is set to No. Provide an existing source category name from the GuardDuty logs. This is used for app installation."
    Default: "aws/quickstart/guardduty/logs"

  # VPC flow logs apps parameters
  Section4aInstallVpcApps:
    Type: String
    Description: "VPC: Install Amazon VPC flow logs app in Sumo Logic.
      PCI_VPC: Install PCI compliance VPC flow app.
      CSMA_VPC: Install Amazon VPC Flow - Cloud Security Monitoring and Analytics app.
      All: Install both apps.
      Skip: Skip installation of apps."
    Default: "All"
    AllowedValues:
      - "VPC"
      - "PCI_VPC"
      - "CSMA_VPC"
      - "All"
      - "Skip"
  Section4bVpcCreateBucket:
    Type: String
    Description: "Choose Yes to create an S3 bucket for VPC flow logs."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section4cVpcLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name that has VPC flow logs."
    Default: ""
  Section4dVpcCreateS3Source:
    Type: String
    Description: "Choose No to skip creation of a Sumo Logic S3 log source."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section4eVpcBucketPathExpression:
    Type: String
    Description: "Path expression must match the folder structure for VPC flow logs (e.g., VPC-FLOW-LOGS/*)."
    Default: "VPC-FLOW-LOGS/*"
  Section4fVpcLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting VPC flow logs. This is used for Threat Intel as well."
    Default: "aws/quickstart/vpc/flow/logs"

  # Threat Intel for AWS Parameters
  Section5aInstallThreatIntelApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section5bElasticLoadBalancerSourceCategory:
    Type: String
    Description: "Provide an existing source category from Sumo Logic that has ELB classic logs."
    Default: "*elb*"

  # S3 Audit apps parameters
  Section6aInstallS3AuditApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section6bS3AuditCreateBucket:
    Type: String
    Description: "Choose Yes to create an S3 bucket for S3 Audit logs."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section6cS3AuditLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing S3 bucket that has audit logs."
    Default: ""
  Section6dS3AuditCreateS3Source:
    Type: String
    Description: "Choose No to skip creation of the Sumo Logic S3 Audit log source."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section6eS3AuditBucketPathExpression:
    Type: String
    Description: "Path expression must match the folder structure for S3 Audit logs (e.g., S3-AUDIT-LOGS/*)."
    Default: "S3-AUDIT-LOGS/*"
  Section6fS3AuditLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting S3 Audit logs. This is used for app installation."
    Default: "aws/quickstart/s3/audit/logs"

  # Security Hub app Parameters
  Section7aInstallSecurityHubAuditApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section7bEnableSecurityHub:
    Type: String
    Description: "Choose Yes if Security Hub must be enabled for the Region."
    Default: "Yes"
    AllowedValues: ["Yes", "No"]
  Section7cSecurityHubCreateBucket:
    Type: String
    Description: "Choose Yes to create an S3 bucket for Security Hub logs."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section7dSecurityHubLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing S3 bucket that has Security Hub logs."
    Default: ""
  Section7eSecurityHubCreateS3Source:
    Type: String
    Description: "Choose No to skip creation of a Sumo Logic S3 logs source."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section7fSecurityHubBucketPathExpression:
    Type: String
    Description: "Path expression must match the folder structure for Security Hub logs (e.g., *securityhub*/*)."
    Default: "*securityhub*/*"
  Section7gSecurityHubLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting Security Hub logs. This is used for app installation."
    Default: "aws/quickstart/securityhub/logs"

  # WAF app Parameters
  Section8aInstallWafApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section8bWafCreateBucket:
    Type: String
    Description: "Choose Yes to create an S3 bucket where Kinesis Data Firehose backs up your data"
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section8cWafLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name in your account"
    Default: ""
  Section8dWafCreateDeliveryStreamSource:
    Type: String
    Description: "Yes - to create Kinesis Delivery Stream Source for WAF.
                  No - to skip creation Kinesis Delivery Stream."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section8eWafDeliveryStreamSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting WAF logs. This is used for app installation."
    Default: "aws/quickstart/waf/logs"

  # Config app Parameters
  Section9aInstallConfigApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section9bConfigCreateBucket:
    Type: String
    Description:
      "Yes - Create a new bucket in AWS S3"
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section9cConfigLogsBucketName:
    Type: String
    Description: "Provide a bucket name to receive configuration history and configuration snapshot files."
    Default: ""
  Section9dConfigCreateS3LogsSource:
    Type: String
    Description:
      "Yes - to create Sumo Logic Amazon S3 Logs Source with provided bucket Name.
      No - to skip creation of the Sumo Logic Amazon S3 Log Source."    
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section9eConfigS3BucketLogsPathExpression:
    Type: String
    Description: Path expression must match one or more S3 objects. For example, ABC*.log or ABC.log
    Default: "AWSLogs/*/Config/*/"
      
  Section9fConfigS3LogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting Config logs. This is used for app installation."
    Default: "aws/quickstart/config/logs"

  # Auto-enable parameters
  Section10aEnableAutoLogging:
    Type: String
    Description: "S3: Enable S3 Audit logging for new S3 buckets.
      VPC: Enable VPC flow logs for new VPC, subnets, and network interfaces.
      Firewall: Enable Network Firewall logs for new firewall."
    AllowedPattern: ".+"
    Default: "Skip"
    AllowedValues:
      - "S3"
      - "VPC"
      - "Firewall"
      - "All"
      - "Skip"
  Section10bEnableLoggingForExistingResources:
    Type: String
    Description: "Choose Yes to enable logging for existing AWS resources."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section10cS3LoggingBucketPrefix:
    Type: String
    Description: "Provide a prefix for the S3 bucket for S3 Audit logs. The prefix should have a slash (/) at the end."
    AllowedPattern: ".*\\/$"
    ConstraintDescription: "Bucket prefix should have slash (/) at the end."
    Default: "S3_AUDIT_LOGS/"
  Section10dS3LoggingFilterExpression:
    Type: String
    Default: ""
    Description: "Provide a regular expression for matching S3 buckets (e.g., 'test|prod')."
  Section10eVPCLoggingBucketPrefix:
    Type: String
    Description: "Provide a prefix for the S3 bucket for VPC flow logs. The prefix should have a slash (/) at the end."
    AllowedPattern: ".*\\/$"
    ConstraintDescription: "Bucket prefix should have a slash (/) at the end."
    Default: "VPC_LOGS/"
  Section10fVPCLoggingFilterExpression:
    Type: String
    Default: ""
    Description: "Provide a regular expression for matching VPC resources (e.g., 'VpcId': 't1.micro.*?'|'NetworkInterfaceId': 'Test.*?']|'SubnetId': 'prod.*?'|test|prod')."
  Section10FireWallLoggingFilterExpression:
    Type: String
    Default: ""
    Description: "Provide a regular expression for matching firewall resources (e.g., 'FirewallName': 'firewall-example.*?')."

  # Network Firewall apps Parameters
  Section11InstallNFWApp:
    Type: String
    Description: "Choose No to skip installation of the app."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section11CreateNewFW:
    Type: String
    Description: "Choose Yes to create an AWS Network Firewall firewall."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section11VPCID:
    Type: String
    Description: "Skip if No is selected. A VPC ID mapping to a new AWS Network Firewall firewall."
    Default: ""
  Section11SubnetID:
    Type: String
    Description: "Skip if No is selected. A subnet ID mapping to a new AWS Network Firewall firewall."
    Default: ""
  Section11CreateFirewallPolicy:
    Type: String
    Description: "Choose Yes to create a policy for the new firewall."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section11FirewallPolicyArn:
    Type: String
    Description: "Skip if Yes is selected. Enter the ARN of the existing firewall policy."
    Default: ""

  Section11StatefulRule:
    Type: String
    Description:
      'Skip if using an existing firewall policy. Enter a stateful rule.
      Example: reject tls any any -> any any (msg:"TLS 1.0 or 1.1"; ssl_version:tls1.0,tls1.1; sid:2023070518;)'
    Default: ""

  Section11StatelessRule:
    Type: String
    Description: "Skip if using an existing firewall policy. Enter an allowed port."
    Default: "80"

  Section11NFWCreateS3Bucket:
    Type: String
    Description: "Choose Yes to create an S3 bucket for Network Firewall logs."
    Default: "No"
    AllowedValues:
      - "Yes"
      - "No"
  Section11NFWLogsS3BucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name that has NFW logs."
    Default: ""
  Section11NFWLogsNFWBucketPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "S3 bucket prefix for Network Firewall logs can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: "NFW/"
    Description: "S3 key prefix for Network Firewall logs. Bucket prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: "String"

  Section11NFWCreateS3Source:
    Type: String
    Description: "Choose No to skip creation of a Sumo Logic Amazon S3 log source."
    Default: "Yes"
    AllowedValues:
      - "Yes"
      - "No"
  Section11NFWS3BucketLogsPathExpression:
    Type: String
    Description: Path expression must match one or more S3 objects. For example, ABC*.log or ABC.log
    Default: "NFW/*"
  Section11NFWS3SourceCategoryName:
    Type: String
    Description:
      "Existing - Change to an existing source category from Sumo Logic if Amazon S3 source is not created.
      New - Default will be used if Amazon S3 source is created."
    Default: "aws/quickstart/nfw/logs"

  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription:
      "The Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a
      hyphen (-)."
    Default: "aws-ia"
    Description: "Name of the S3 bucket for your copy of the Quick Start assets.
      Keep the default name unless you are customizing the template.
      Changing the name updates code references to point to a new Quick
      Start location. This name can include numbers, lowercase letters,
      uppercase letters, and hyphens, but do not start or end with a hyphen (-).
      See https://aws-quickstart.github.io/option1.html."
    Type: "String"
  QSS3BucketRegion:
    Default: "us-east-1"
    Description: "AWS Region where the Quick Start S3 bucket (QSS3BucketName) is
      hosted. Keep the default Region unless you are customizing the template.
      Changing this Region updates code references to point to a new Quick Start location.
      When using your own bucket, specify the Region.
      See https://aws-quickstart.github.io/option1.html."
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription:
      "The Quick Start S3 key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slashes (/). The prefix should
      end with a forward slash (/)."
    Default: "cfn-ps-sumo-logic-log-centralization/"
    Description:
      "S3 key prefix that is used to simulate a directory for your copy of the
      Quick Start assets. Keep the default prefix unless you are customizing
      the template. Changing this prefix updates code references to point to
      a new Quick Start location. This prefix can include numbers, lowercase
      letters, uppercase letters, hyphens (-), and forward slashes (/). End with
      a forward slash. See https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html
      and https://aws-quickstart.github.io/option1.html."
    Type: "String"
  QSVersion:
    Type: String
    Description: "Version of the Quick Start. Do not change."
    Default: "2"

Conditions:
  # Conditions for CloudTrail apps
  install_cloudtrail_app: !Equals [!Ref Section2aInstallCloudTrailApp, "Yes"]
  install_pci_cloudtrail_app:
    !Equals [!Ref Section2bInstallPCICloudTrailApp, "Yes"]
  install_cis_foundations_app:
    !Equals [!Ref Section2cInstallCISFoundationApp, "Yes"]
  install_cloudtrail_monitoring_analytics_app:
    !Equals [!Ref Section2dInstallCloudTrailMonitoringAnalyticsApp, "Yes"]
  install_cloudtrail_secops_app:
    !Equals [!Ref Section2eInstallCloudTrailSecOpsApp, "Yes"]
  create_cloudtrail_bucket: !Equals [!Ref Section2fCloudTrailCreateBucket, "Yes"]
  create_cloudtrail_source:
    !Equals [!Ref Section2hCloudTrailCreateLogSource, "Yes"]

  # Conditions for GuardDuty apps
  install_guardduty_app: !Or
    - !Equals [!Ref Section3aInstallGuardDutyApps, "GuardDuty"]
    - !Equals [!Ref Section3aInstallGuardDutyApps, "Both"]
  install_global_guardduty_app: !Or
    - !Equals [!Ref Section3aInstallGuardDutyApps, "GlobalGuardDuty"]
    - !Equals [!Ref Section3aInstallGuardDutyApps, "Both"]
  create_guardduty_source:
    !Equals [!Ref Section3bGuardDutyCreateHttpLogsSource, "Yes"]

  # Conditions for VPC flow logs apps
  install_vpc_app: !Or
    - !Equals [!Ref Section4aInstallVpcApps, "VPC"]
    - !Equals [!Ref Section4aInstallVpcApps, "All"]
  install_pci_vpc_app: !Or
    - !Equals [!Ref Section4aInstallVpcApps, "PCI_VPC"]
    - !Equals [!Ref Section4aInstallVpcApps, "All"]
  install_csma_vpc_app: !Or
    - !Equals [!Ref Section4aInstallVpcApps, "CSMA_VPC"]
    - !Equals [!Ref Section4aInstallVpcApps, "All"]
  create_vpc_bucket: !Equals [!Ref Section4bVpcCreateBucket, "Yes"]
  create_vpc_source: !Equals [!Ref Section4dVpcCreateS3Source, "Yes"]

  # Conditions for Threat Intel app
  install_threat_intel_app: !Equals [!Ref Section5aInstallThreatIntelApp, "Yes"]

  # Conditions for S3 Audit app
  install_s3_audit_app: !Equals [!Ref Section6aInstallS3AuditApp, "Yes"]
  create_s3_audit_bucket: !Equals [!Ref Section6bS3AuditCreateBucket, "Yes"]
  create_s3_audit_source: !Equals [!Ref Section6dS3AuditCreateS3Source, "Yes"]

  # Conditions for Security Hub app
  install_security_hub_app:
    !Equals [!Ref Section7aInstallSecurityHubAuditApp, "Yes"]
  enable_security_hub: !Equals [!Ref Section7bEnableSecurityHub, "Yes"]
  create_security_hub_bucket:
    !Equals [!Ref Section7cSecurityHubCreateBucket, "Yes"]
  create_security_hub_source:
    !Equals [!Ref Section7eSecurityHubCreateS3Source, "Yes"]

  # Conditions for WAF app
  install_waf_app: !Equals [!Ref Section8aInstallWafApp, "Yes"]
  create_waf_bucket: !Equals [!Ref Section8bWafCreateBucket, "Yes"]
  create_waf_source: !Equals [!Ref Section8dWafCreateDeliveryStreamSource, "Yes"]

  # Conditions for Config app
  install_config_app: !Equals [!Ref Section9aInstallConfigApp, "Yes"]
  create_config_bucket: !Equals [!Ref Section9bConfigCreateBucket, "Yes"]
  create_config_source:
    !Equals [!Ref Section9dConfigCreateS3LogsSource, "Yes"]

  #conditions for NFW app
  install_nfw_app: !Equals [!Ref Section11InstallNFWApp, "Yes"]
  create_nfw_bucket: !Equals [!Ref Section11NFWCreateS3Bucket, "Yes"]
  create_nfw_source: !Equals [!Ref Section11NFWCreateS3Source, "Yes"]
  # Conditions for auto-enable
  auto_enable_s3_audit: !Or
    - !Equals [!Ref Section10aEnableAutoLogging, "S3"]
    - !Equals [!Ref Section10aEnableAutoLogging, "All"]
  auto_enable_vpc_logs: !Or
    - !Equals [!Ref Section10aEnableAutoLogging, "VPC"]
    - !Equals [!Ref Section10aEnableAutoLogging, "All"]
  auto_enable_firewall_logs: !Or
    - !Equals [!Ref Section10aEnableAutoLogging, "Firewall"]
    - !Equals [!Ref Section10aEnableAutoLogging, "All"]
  auto_exisitng_resources:
    !Equals [!Ref Section10bEnableLoggingForExistingResources, "Yes"]

  # Conditions for common resources
  create_common_s3_bucket: !Or
    - !Condition create_cloudtrail_bucket
    - !Condition create_vpc_bucket
    - !Condition create_s3_audit_bucket
    - !Condition create_security_hub_bucket
    - !Condition create_waf_bucket
    - !Condition create_config_bucket
    - !Condition create_nfw_bucket
  create_common_collector: !Or
    - !Condition create_cloudtrail_source
    - !Condition create_guardduty_source
    - !Condition create_vpc_source
    - !Condition create_s3_audit_source
    - !Condition create_security_hub_source
    - !Condition create_waf_source
    - !Condition create_config_source
    - !Condition create_nfw_source
  create_cloudtrail: !Or
    - !Condition create_cloudtrail_bucket
    - !Condition auto_enable_s3_audit
    - !Condition auto_enable_vpc_logs
    - !Condition auto_enable_firewall_logs
    - !Condition create_config_bucket

  # Conditions for calling child stack of each app if any resource create condition is true.
  call_cloudtrail_stack: !Or
    - !Condition install_cloudtrail_app
    - !Condition install_pci_cloudtrail_app
    - !Condition install_cis_foundations_app
    - !Condition install_cloudtrail_monitoring_analytics_app
    - !Condition install_cloudtrail_secops_app
    - !Condition create_cloudtrail_source
  call_guardduty_stack: !Or
    - !Condition install_guardduty_app
    - !Condition install_global_guardduty_app
    - !Condition create_guardduty_source
  call_vpc_stack: !Or
    - !Condition install_vpc_app
    - !Condition install_pci_vpc_app
    - !Condition install_csma_vpc_app
    - !Condition create_vpc_source
  call_threat_intel_stack: !Condition install_threat_intel_app
  call_s3_audit_stack: !Or
    - !Condition install_s3_audit_app
    - !Condition create_s3_audit_source
  call_security_hub_stack: !Or
    - !Condition install_security_hub_app
    - !Condition enable_security_hub
    - !Condition create_security_hub_source
  call_waf_stack: !Or
    - !Condition install_waf_app
    - !Condition create_waf_source
  call_config_stack: !Or
    - !Condition install_config_app
    - !Condition create_config_bucket
    - !Condition create_config_source
  call_nfw_stack: !Or
    - !Condition install_nfw_app
    - !Condition create_nfw_source

  UsingDefaultBucket: !Or [ !Equals [!Ref QSS3BucketName, 'aws-ia'], !Equals [!Ref QSS3BucketName, 'sumologic-aws-security-solutions'] ]

Resources:

  CreateCommonResources:
    Type: AWS::CloudFormation::Stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/common/resources.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        CreateCollector: !If [create_common_collector, "Yes", "No"]
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateBucket: !If [create_common_s3_bucket, "Yes", "No"]
        BucketName: !Join
          - ""
          - - "aws-quickstart-logs-"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split ["/", !Ref "AWS::StackId"]
        CreateTrail: !If [create_cloudtrail, "Yes", "No"]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  SumoCloudTrailAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_cloudtrail_stack
    # DependsOn: CreateCommonResources
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/cloudtrail/cloudtrail.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallCloudTrailApp: !Ref Section2aInstallCloudTrailApp
        InstallPCICloudTrailApp: !Ref Section2bInstallPCICloudTrailApp
        InstallCISFoundationApp: !Ref Section2cInstallCISFoundationApp
        InstallCloudTrailMonitoringAnalyticsApp: !Ref Section2dInstallCloudTrailMonitoringAnalyticsApp
        InstallCloudTrailSecOpsApp: !Ref Section2eInstallCloudTrailSecOpsApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateCloudTrailBucket: "No"
        CloudTrailLogsBucketName:
          !If [
            create_cloudtrail_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section2gCloudTrailLogsBucketName,
          ]
        CreateCloudTrailLogSource: !If [create_cloudtrail_source, "Yes", "No"]
        CloudTrailBucketPathExpression:
          !If [
            create_cloudtrail_bucket,
            !Sub "AWSLogs/${AWS::AccountId}/CloudTrail/*",
            !Ref Section2iCloudTrailBucketPathExpression,
          ]
        CloudTrailLogsSourceName: !Sub "aws-quickstart-cloudtrail-${AWS::Region}"
        CloudTrailLogsSourceCategoryName:
          !If [
            create_cloudtrail_source,
            "aws/quickstart/cloudtrail/logs",
            !Ref Section2jCloudTrailLogsSourceCategoryName,
          ]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoGuardDutyAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_guardduty_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/guardduty/guardduty.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallGuardDutyApp: !If [install_guardduty_app, "Yes", "No"]
        InstallGlobalGuardDutyApp:
          !If [install_global_guardduty_app, "Yes", "No"]
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateHttpLogsSource: !If [create_guardduty_source, "Yes", "No"]
        HttpLogsSourceName: !Sub "aws-quickstart-guardduty-${AWS::Region}"
        HttpLogsSourceCategoryName:
          !If [
            create_guardduty_source,
            "aws/quickstart/guardduty/logs",
            !Ref Section3cGuardDutyHttpLogsSourceCategoryName,
          ]
        QSS3BucketName: !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoVpcAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_vpc_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/vpc-flow-logs/vpcflowlogs.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallVpcApp: !If [install_vpc_app, "Yes", "No"]
        InstallPCIVpcApp: !If [install_pci_vpc_app, "Yes", "No"]
        InstallCSMAVpcApp: !If [install_csma_vpc_app, "Yes", "No"]
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName:
          !If [
            create_vpc_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section4cVpcLogsBucketName,
          ]
        CreateS3Source: !If [create_vpc_source, "Yes", "No"]
        S3BucketLogsPathExpression:
          !If [
            auto_enable_vpc_logs,
            !Sub "${Section10eVPCLoggingBucketPrefix}*",
            !Ref Section4eVpcBucketPathExpression,
          ]
        S3SourceName: !Sub "aws-quickstart-vpc-${AWS::Region}"
        S3SourceCategoryName:
          !If [
            create_vpc_source,
            "aws/quickstart/vpc/flow/logs",
            !Ref Section4fVpcLogsSourceCategoryName,
          ]
        QSS3BucketName: !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                          !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoThreatIntelAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_threat_intel_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/threat-intel-for-aws/threatintel.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        CloudTrailSourceCategory:
          !If [
            create_cloudtrail_source,
            "aws/quickstart/cloudtrail/logs",
            !Ref Section2jCloudTrailLogsSourceCategoryName,
          ]
        VPCFlowLogsSourceCategory:
          !If [
            create_vpc_source,
            "aws/quickstart/vpc/flow/logs",
            !Ref Section4fVpcLogsSourceCategoryName,
          ]
        ElasticLoadBalancerSourceCategory: !Ref Section5bElasticLoadBalancerSourceCategory
        QSS3BucketName: !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                          !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                            !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoS3AuditAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_s3_audit_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/s3-audit/s3audit.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section6aInstallS3AuditApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName:
          !If [
            create_s3_audit_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section6cS3AuditLogsBucketName,
          ]
        CreateS3AuditSource: !If [create_s3_audit_source, "Yes", "No"]
        S3BucketLogsPathExpression:
          !If [
            auto_enable_s3_audit,
            !Sub "${Section10cS3LoggingBucketPrefix}*",
            !Ref Section6eS3AuditBucketPathExpression,
          ]
        S3AuditSourceName: !Sub "aws-quickstart-s3-audit-${AWS::Region}"
        S3AuditSourceCategoryName:
          !If [
            create_s3_audit_source,
            "aws/quickstart/s3/audit/logs",
            !Ref Section6fS3AuditLogsSourceCategoryName,
          ]
        QSS3BucketName: !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                          !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                            !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                              !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoSecurityHubAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_security_hub_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/security-hub/securityhub.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section7aInstallSecurityHubAuditApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName:
          !If [
            create_security_hub_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section7dSecurityHubLogsBucketName,
          ]
        CreateS3Source: !If [create_security_hub_source, "Yes", "No"]
        S3BucketLogsPathExpression:
          !If [
            create_security_hub_bucket,
            "*securityhub*/*",
            !Ref Section7fSecurityHubBucketPathExpression,
          ]
        S3SourceName: !Sub "aws-quickstart-securityhub-${AWS::Region}"
        S3SourceCategoryName:
          !If [
            create_security_hub_source,
            "aws/quickstart/securityhub/logs",
            !Ref Section7gSecurityHubLogsSourceCategoryName,
          ]
        EnableSecurityHub: !If [enable_security_hub, "Yes", "No"]
        ConnectionName: !Sub "SecurityHubConnection${AWS::Region}-${AWS::AccountId}"
        QSS3BucketName: !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                          !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                            !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                              !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoWafAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_waf_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/WAF/waf.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section8aInstallWafApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName:
          !If [
            create_waf_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section8cWafLogsBucketName,
          ]
        CreateDeliveryStreamSource: !If [create_waf_source, "Yes", "No"]
        DeliveryStreamSourceCategoryName:
          !If [
            create_waf_source,
            "aws/quickstart/waf/logs",
            !Ref Section8eWafDeliveryStreamSourceCategoryName,
          ]
        DeliveryStreamSourceName: !Sub "aws-quickstart-waf-${AWS::Region}"
        DeliveryStreamName: !Sub "aws-qs-awf-${AWS::StackName}"
        QSS3BucketName: !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                          !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                            !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                              !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                  !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoConfigAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_config_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/config/config.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section9aInstallConfigApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        BucketName: !If [
            create_config_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section9cConfigLogsBucketName,
          ]
        CreateSNSTopic: "No"
        CreateS3Bucket: "No"
        CreateS3LogsSource: !If [create_config_source, "Yes", "No"]
        S3BucketLogsPathExpression: !If [
            create_config_bucket,
            !Sub "AWSLogs/*/Config/${AWS::Region}/*",
            !Ref Section9eConfigS3BucketLogsPathExpression,
          ]
        S3LogsSourceName: !Sub "aws-quickstart-config-${AWS::Region}"
        S3LogsSourceCategoryName:
          !If [
            create_config_source,
            "aws/quickstart/config/logs",
            !Ref Section9fConfigS3LogsSourceCategoryName,
          ]
        QSS3BucketName: !If [call_waf_stack, !GetAtt SumoWafAppsStack.Outputs.QSS3BucketName,
                          !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                            !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                              !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                                !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                  !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                    !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoFireWallMacroStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_nfw_stack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/network-firewall/networkfw_macro.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        QSS3BucketName: !If [call_config_stack, !GetAtt SumoConfigAppsStack.Outputs.QSS3BucketName,
                          !If [call_waf_stack, !GetAtt SumoWafAppsStack.Outputs.QSS3BucketName,
                            !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                              !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                                !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                                  !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                    !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                      !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  SumoFireWallAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_nfw_stack
    DependsOn: SumoFireWallMacroStack
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/network-firewall/networkfw.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallNFWApp: !Ref Section11InstallNFWApp
        CreateNewFW: !Ref Section11CreateNewFW
        VPCID: !Ref Section11VPCID
        SubnetID: !Ref Section11SubnetID
        CreateFirewallPolicy: !Ref Section11CreateFirewallPolicy
        NameFirewallPolicy: !Ref Section11FirewallPolicyArn
        StatefulRule: !Ref Section11StatefulRule
        StatelessRule: !Ref Section11StatelessRule
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName:
          !If [
            create_nfw_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section11NFWLogsS3BucketName,
          ]
        LogsNFWBucketPrefix: !Ref Section11NFWLogsNFWBucketPrefix
        CreateS3Source: !If [create_nfw_source, "Yes", "No"]
        S3BucketLogsPathExpression:
          !If [
            create_nfw_bucket,
            !Sub "NFW/*",
            !Ref Section11NFWS3BucketLogsPathExpression,
          ]
        S3SourceName: !Sub "aws-quickstart-nfw-${AWS::Region}"
        S3SourceCategoryName:
          !If [
            create_nfw_source,
            "aws/quickstart/nfw/logs",
            !Ref Section11NFWS3SourceCategoryName,
          ]
        QSS3BucketName: !If [call_config_stack, !GetAtt SumoConfigAppsStack.Outputs.QSS3BucketName,
                          !If [call_waf_stack, !GetAtt SumoWafAppsStack.Outputs.QSS3BucketName,
                            !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                              !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                                !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                                  !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                    !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                      !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  SumoAutoEnableS3AuditLogs:
    Type: AWS::CloudFormation::Stack
    Condition: auto_enable_s3_audit
    # DependsOn: CreateCommonResources
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/AutoEnableS3Logging/auto_enable_s3_logging.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        EnableLogging: "S3"
        ExistingResource: !If [auto_exisitng_resources, "Yes", "No"]
        BucketName:
          !If [
            create_s3_audit_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section6cS3AuditLogsBucketName,
          ]
        BucketPrefix: !Ref Section10cS3LoggingBucketPrefix
        FilterExpression: !Ref Section10dS3LoggingFilterExpression
        QSS3BucketName: !If [call_nfw_stack, !GetAtt SumoFireWallAppsStack.Outputs.QSS3BucketName,
                          !If [call_config_stack, !GetAtt SumoConfigAppsStack.Outputs.QSS3BucketName,
                            !If [call_waf_stack, !GetAtt SumoWafAppsStack.Outputs.QSS3BucketName,
                              !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                                !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                                  !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                                    !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                      !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                        !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  SumoAutoEnableVpcAuditLogs:
    Type: AWS::CloudFormation::Stack
    Condition: auto_enable_vpc_logs
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/AutoEnableS3Logging/auto_enable_s3_logging.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        EnableLogging: "VPC"
        ExistingResource: !If [auto_exisitng_resources, "Yes", "No"]
        BucketName:
          !If [
            create_vpc_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section4cVpcLogsBucketName,
          ]
        BucketPrefix: !Ref Section10eVPCLoggingBucketPrefix
        FilterExpression: !Ref Section10fVPCLoggingFilterExpression
        QSS3BucketName: !If [auto_enable_s3_audit, !GetAtt SumoAutoEnableS3AuditLogs.Outputs.QSS3BucketName,
                          !If [call_nfw_stack, !GetAtt SumoFireWallAppsStack.Outputs.QSS3BucketName,
                            !If [call_config_stack, !GetAtt SumoConfigAppsStack.Outputs.QSS3BucketName,
                              !If [call_waf_stack, !GetAtt SumoWafAppsStack.Outputs.QSS3BucketName,
                                !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                                  !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                                    !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                                      !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                        !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                          !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        QSVersion: !Ref QSVersion

  SumoAutoEnableFirewallAuditLogs:
    Type: AWS::CloudFormation::Stack
    Condition: auto_enable_firewall_logs
    Properties:
      Tags:
        - Key: "version"
          Value: !Ref QSVersion
      TemplateURL: !Sub
        - "https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/apps/sumo-aws-apps/AutoEnableS3Logging/auto_enable_s3_logging.template.yaml"
        - S3Region:
            !If [UsingDefaultBucket, !Ref "AWS::Region", !Ref QSS3BucketRegion]
          S3Bucket:
            !If [
              UsingDefaultBucket,
              !Sub "${QSS3BucketName}-${AWS::Region}",
              !Ref QSS3BucketName,
            ]
      Parameters:
        EnableLogging: "Firewall"
        ExistingResource: !If [auto_exisitng_resources, "Yes", "No"]
        BucketName:
          !If [
            create_nfw_bucket,
            !GetAtt CreateCommonResources.Outputs.BucketName,
            !Ref Section11NFWLogsS3BucketName,
          ]
        BucketPrefix: !Ref Section11NFWLogsNFWBucketPrefix
        FilterExpression: !Ref Section10FireWallLoggingFilterExpression
        QSS3BucketName: !If [auto_enable_vpc_logs, !GetAtt SumoAutoEnableVpcAuditLogs.Outputs.QSS3BucketName,
                          !If [auto_enable_s3_audit, !GetAtt SumoAutoEnableS3AuditLogs.Outputs.QSS3BucketName,
                            !If [call_nfw_stack, !GetAtt SumoFireWallAppsStack.Outputs.QSS3BucketName,
                              !If [call_config_stack, !GetAtt SumoConfigAppsStack.Outputs.QSS3BucketName,
                                !If [call_waf_stack, !GetAtt SumoWafAppsStack.Outputs.QSS3BucketName,
                                  !If [call_security_hub_stack, !GetAtt SumoSecurityHubAppsStack.Outputs.QSS3BucketName,
                                    !If [call_s3_audit_stack, !GetAtt SumoS3AuditAppsStack.Outputs.QSS3BucketName,
                                      !If [call_threat_intel_stack, !GetAtt SumoThreatIntelAppsStack.Outputs.QSS3BucketName,
                                        !If [call_vpc_stack, !GetAtt SumoVpcAppsStack.Outputs.QSS3BucketName, 
                                          !If [call_guardduty_stack, !GetAtt SumoGuardDutyAppsStack.Outputs.QSS3BucketName,
                                            !If [call_cloudtrail_stack, !GetAtt SumoCloudTrailAppsStack.Outputs.QSS3BucketName, !Ref QSS3BucketName]]]]]]]]]]]
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
